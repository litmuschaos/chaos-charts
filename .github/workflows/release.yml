# The CI will create a release branch 
# with CR updated with release tag

# The workflow will trigger when a release tag is created
name: ChaosCharts-Release
on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'     
        required: true
        default: 'warning'
      tag:
        description: 'Releae tag'
        required: true
      branch:
        description: 'Release branch name'
    
jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    # It will checkout to the relase branch provided in the secret
    - name: Checkout to release branch
      run: |
        git config --local user.email "litmuschaos@gmail.com"
        git config --local user.name "LitmusChaos"
        git checkout -b ${{ github.event.inputs.branch }}
        
    # It will update the image tag as provided in the secret
    - name: Update the chaos-charts version
      run: |
        find charts -type f -exec sed -i 's/\:latest/\:${{ github.event.inputs.tag }}/g' {} \;
        find scripts/version -type f -exec sed -i 's/master/${{ github.event.inputs.branch }}/g' {} \;

    - name: Commit files
      run: |
        git add .          
        git commit -s -m "New Release ${{ github.event.inputs.tag }}"
  
    # It will push the changes in realse branch
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.event.inputs.branch }}